KLUv/QQAKQAAMTExMTLpHH/k#!/bin/bash

CONFIG_FILE="cmd/otelcontribcol/builder-config.yaml"

# Check if the file exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Builder config file not found at $CONFIG_FILE"
    exit 1
fi

# Check if compression processor is already in the file
if grep -q "compressionprocessor" "$CONFIG_FILE"; then
    echo "Compression processor is already included in the builder config"
    exit 0
fi

# Find the processors section and add the compression processor
awk '
/^processors:/ {
    print $0
    print "  - gomod: github.com/open-telemetry/opentelemetry-collector-contrib/processor/compressionprocessor"
    next
}
{print}
' "$CONFIG_FILE" > "${CONFIG_FILE}.new"

# Replace the original file
mv "${CONFIG_FILE}.new" "$CONFIG_FILE"

echo "Successfully added compression processor to $CONFIG_FILE"

# Make the script tell the user to rebuild the collector
echo "Please rebuild the collector using:"
echo "make docker-otelcontribcol"
echo "docker compose up"
